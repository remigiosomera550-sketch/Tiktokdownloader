// server.js
// Node 18+ recommended (fetch builtin). If using older Node, install node-fetch.
import express from 'express';
import cors from 'cors';

const app = express();
app.use(cors()); // allow browser calls
app.use(express.json());

const PORT = process.env.PORT || 3000;
// replace this with the API base you have
const EXTERNAL_BASE = 'https://betadash-api-swordslush-production.up.railway.app/api/tiktok?link=';

function pickVideoUrl(data) {
  // Try common shapes
  if (!data) return null;
  if (Array.isArray(data.downloadUrls)) {
    for (const v of data.downloadUrls) if (v) return v;
  }
  if (typeof data.downloadUrl === 'string' && data.downloadUrl.startsWith('http')) return data.downloadUrl;
  if (typeof data.videoUrl === 'string' && data.videoUrl.startsWith('http')) return data.videoUrl;
  if (typeof data.url === 'string' && data.url.startsWith('http')) return data.url;

  // nested search (shallow)
  if (data.data && typeof data.data === 'object') {
    const keys = Object.keys(data.data);
    for (const k of keys) {
      const val = data.data[k];
      if (typeof val === 'string' && val.startsWith('http')) return val;
      if (val && typeof val === 'object') {
        for (const k2 of Object.keys(val)) {
          const vv = val[k2];
          if (typeof vv === 'string' && vv.startsWith('http')) return vv;
        }
      }
    }
  }
  return null;
}

app.get('/api/tiktok', async (req, res) => {
  const link = req.query.link;
  if (!link) return res.status(400).json({ error: 'missing link query param' });

  const apiUrl = EXTERNAL_BASE + encodeURIComponent(link);

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 20000);

    const response = await fetch(apiUrl, { signal: controller.signal });
    clearTimeout(timeout);

    if (!response.ok) {
      const txt = await response.text().catch(()=>null);
      return res.status(502).json({ error: 'external API error', status: response.status, body: txt });
    }

    const data = await response.json().catch(()=>null);
    if (!data) return res.status(502).json({ error: 'invalid JSON from extractor' });

    const videoUrl = pickVideoUrl(data);

    // if found, return a small JSON with direct URL
    if (videoUrl) {
      return res.json({ success: true, videoUrl, title: data.title || null, raw: data });
    }

    // not found: return raw for debugging
    return res.json({ success: false, reason: 'no direct url found', raw: data });

  } catch (err) {
    console.error('fetch error', err?.message || err);
    if (err.name === 'AbortError') return res.status(504).json({ error: 'timeout' });
    return res.status(500).json({ error: err.message || String(err) });
  }
});

app.listen(PORT, ()=> console.log(`tiktok-proxy running on http://localhost:${PORT}`));
